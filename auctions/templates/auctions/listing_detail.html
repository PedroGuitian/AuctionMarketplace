{% extends "auctions/layout.html" %}

{% block body %}

  <div class="container listing-detail-card p-4 bg-white rounded shadow-sm">
    <h2 class="mb-3">{{ listing.title }}</h2>

    {% if not listing.is_active %}
      <p class="text-danger"><strong>Auction Closed</strong></p>
      {% if listing.winner_user %}
        {% if user == listing.winner_user %}
          <p class="text-success"><strong>Congratulations! You won this auction!</strong></p>
        {% else %}
          <p>Winner: {{ listing.winner_user.username }}</p>
        {% endif %}
      {% else %}
        <p>No bids were placed on this listing.</p>
      {% endif %}
    {% endif %}

    {% if listing.image %}
      <img src="{{ listing.image }}" alt="{{ listing.title }}" class="img-fluid rounded mb-3" style="max-height: 400px; object-fit: cover;">
    {% endif %}

    <p class="mb-1 text-muted">Posted by: {{ listing.creator.username }}</p>
    <p class="mb-1 text-muted">Category: {{ listing.product_category }}</p>
    <p class="listing-price mb-2">Starting bid: ${{ listing.starting_bid }}</p>
    <p class="listing-price mb-3">Highest bid: ${{ highest_bid_amount }}</p>
    <p>{{ listing.description }}</p>

    {% if listing.is_active %}
      <form method="post" action="{% url 'bid' listing.id %}" class="mb-3">
        {% csrf_token %}
        <div class="form-group">
          <input type="number" id="bid_amount" name="bid_amount" min="{{ highest_bid_amount }}" class="form-control mb-2" placeholder="Your bid">
          <button type="submit" class="btn btn-success w-100">Place Bid</button>
        </div>
      </form>
    {% endif %}

    {% if user == listing.creator and listing.is_active %}
      <form method="post" action="{% url 'close_auction' listing.id %}" class="mb-3">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning w-100">Close Auction</button>
      </form>
    {% endif %}

    {% if user != listing.creator %}
      <form method="post" action="{% url 'add_watchlist' listing.id %}" class="mb-3">
        {% csrf_token %}
        {% if user in listing.watchlist_users.all %}
          <button type="submit" class="btn btn-danger w-100">Remove from Watchlist</button>
        {% else %}
          <button type="submit" class="btn btn-primary w-100">Add to Watchlist</button>
        {% endif %}
      </form>
    {% endif %}

    <hr>

    <h4>Comments</h4>
    <ul class="list-unstyled">
      {% for comment in listing.comments.all %}
        <li class="mb-3 p-3 bg-light rounded">
          <p>{{ comment.comment }}</p>
          <p class="text-muted small">Posted by: {{ comment.comment_user.username }}</p>
        </li>
      {% endfor %}
    </ul>

    <form method="post" action="{% url 'comment' listing.id %}">
      {% csrf_token %}
      <div class="form-group">
        <textarea id="comment" name="comment" class="form-control mb-2" placeholder="Write a comment..." rows="3"></textarea>
        <button type="submit" class="btn btn-outline-success w-100">Post Comment</button>
      </div>
    </form>
  </div>

{% endblock %}
